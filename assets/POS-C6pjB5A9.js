import{b as de,r,g as j,h as pe,c as d,o as p,d as e,j as U,e as v,k as m,v as b,l,x as J,F as $,m as I,t as i,s as X,z as ve,B as me,w as Y,y}from"./index-BfXM_CW9.js";import{f as P,t as B}from"./numbers-BTmV-EI5.js";import{c as F}from"./createLucideIcon-D2m-SOkY.js";import{P as ye}from"./package-Ck0xfNES.js";import{P as fe}from"./plus-Cg4-39y0.js";import{T as be}from"./trash-2-CWWRD5uf.js";import{U as ge}from"./user-plus-DE7QUn53.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=F("MinusIcon",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=F("ScanIcon",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=F("SearchIcon",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=F("ShoppingCartIcon",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),we={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Ce={class:"lg:col-span-2 space-y-4"},qe={class:"card"},Me={class:"flex gap-3"},Pe={class:"flex-1 relative"},ze={class:"grid grid-cols-2 md:grid-cols-3 gap-4"},Ve=["onClick"],Se={class:"aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center"},je={class:"font-bold text-gray-900 mb-1 truncate"},Ue={class:"text-sm text-gray-500 mb-2"},$e={class:"flex items-center justify-between"},Ie={class:"text-lg font-bold text-primary-600"},Be={class:"space-y-4"},Fe={class:"card sticky top-24"},Te={class:"text-xl font-bold mb-4 flex items-center gap-2"},Ae={class:"space-y-3 mb-4 max-h-64 overflow-y-auto"},De={key:0,class:"text-center py-8 text-gray-500"},Le={class:"flex-1"},Ne={class:"font-medium text-sm"},We={class:"text-xs text-gray-500"},Ee={class:"flex items-center gap-2"},Qe=["onClick"],He={class:"w-8 text-center font-bold"},Ke=["onClick"],Re=["onClick"],Oe={class:"mb-4"},Ge={class:"flex gap-2"},Je=["value"],Xe={class:"border-t pt-4 space-y-2"},Ye={class:"flex justify-between text-sm"},Ze={class:"font-bold"},et={class:"flex justify-between text-sm"},tt={class:"flex justify-between text-sm"},st={class:"flex justify-between text-lg font-bold border-t pt-2"},at={class:"text-primary-600"},ot={class:"flex justify-between text-sm bg-blue-50 p-2 rounded"},lt=["placeholder"],nt={key:0,class:"flex justify-between text-sm text-red-600 font-bold"},rt={class:"mt-4"},ut={class:"grid grid-cols-3 gap-2"},it=["onClick"],ct={class:"mt-4 space-y-2"},dt=["disabled"],pt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},vt={class:"bg-white rounded-xl p-6 w-full max-w-md"},mt={class:"flex gap-3"},yt={class:"bg-white rounded-xl p-6 w-full max-w-md"},ft={class:"flex gap-3"},Mt={__name:"POS",setup(bt){const n=de(),k=r([]),z=r([]),u=r([]),f=r(""),w=r(""),g=r(0),x=r(0),C=r(null),T=r("cash"),V=r(!1),q=r(!1),h=r(""),L=r(null),_=r({name:"",phone:""}),Z=[{value:"cash",label:"نقدي"},{value:"card",label:"بطاقة"},{value:"transfer",label:"تحويل"}],ee=j(()=>f.value?k.value.filter(a=>a.name_ar.includes(f.value)||a.barcode.includes(f.value)):k.value.slice(0,12)),N=j(()=>u.value.reduce((a,t)=>a+t.product.selling_price*t.quantity,0)),M=j(()=>N.value+x.value-g.value),W=j(()=>{const a=C.value||M.value;return Math.max(0,M.value-a)}),te=async()=>{if(f.value.length<2){A();return}try{const a=await y.getProducts({search:f.value});k.value=a.data}catch{n.error("فشل البحث")}},se=()=>{V.value=!0,h.value="",setTimeout(()=>{var a;(a=L.value)==null||a.focus()},100)},E=async()=>{if(h.value)try{const a=await y.searchByBarcode(h.value);Q(a.data),V.value=!1,h.value=""}catch{n.error("المنتج غير موجود")}},Q=a=>{if(a.stock_quantity===0){n.error("المنتج غير متوفر في المخزون");return}const t=u.value.find(s=>s.product.id===a.id);if(t){if(t.quantity>=a.stock_quantity){n.error("الكمية المطلوبة غير متوفرة");return}t.quantity++}else u.value.push({product:a,quantity:1});n.success("تم إضافة المنتج للسلة")},ae=a=>{if(a.quantity>=a.product.stock_quantity){n.error("الكمية المطلوبة غير متوفرة");return}a.quantity++},oe=a=>{a.quantity>1?a.quantity--:H(a)},H=a=>{u.value=u.value.filter(t=>t.product.id!==a.product.id)},le=()=>{u.value.length!==0&&confirm("هل أنت متأكد من مسح السلة؟")&&(u.value=[],g.value=0,x.value=0)},ne=async()=>{try{const a=await y.createCustomer(_.value);n.success("تم إضافة العميل بنجاح"),z.value.push(a.data),w.value=a.data.id,q.value=!1,_.value={name:"",phone:""}}catch{n.error("فشل إضافة العميل")}},re=async()=>{var t,s,c;if(u.value.length===0)return;const a={customer_id:w.value||null,items:u.value.map(o=>({product_id:o.product.id,quantity:o.quantity,unit_price:o.product.selling_price})),tax:x.value,discount:g.value,paid_amount:C.value||M.value,payment_method:T.value};try{const o=await y.createSale(a),D=B(o.data.invoice_number);n.success(`تم إنشاء الفاتورة ${D}`);const K=[];if(confirm("هل تريد تحميل الفاتورة PDF؟"))try{await y.downloadInvoicePdf(o.data.id),n.success("تم تحميل الفاتورة بنجاح")}catch(S){console.error("PDF Error:",S),n.error("فشل تحميل الفاتورة PDF")}(t=o.data.customer)!=null&&t.phone&&confirm("هل تريد مشاركة الفاتورة عبر واتساب؟")&&ue(o.data),u.value=[],g.value=0,x.value=0,C.value=null,w.value="",A()}catch(o){n.error(((c=(s=o.response)==null?void 0:s.data)==null?void 0:c.error)||"فشل إنشاء الفاتورة")}},ue=async a=>{var t,s,c;try{console.log("Sharing sale:",a);const o=await y.getWhatsAppMessage(a.id);console.log("WhatsApp response:",o.data);const{message:D,pdf_url:K,phone:S}=o.data;if(!S){n.error("لا يوجد رقم هاتف للعميل");return}const R=S.replace(/[^0-9]/g,"");console.log("Clean phone:",R);const ce=`
`+"-".repeat(30)+`
`+`تحميل الفاتورة:
`+K,O=D+ce;console.log("Full message:",O);const G=`https://wa.me/${R}?text=${encodeURIComponent(O)}`;console.log("WhatsApp URL:",G),window.open(G,"_blank"),n.success("تم فتح واتساب بنجاح")}catch(o){console.error("WhatsApp Error:",o),console.error("Error details:",(t=o.response)==null?void 0:t.data),n.error("فشل مشاركة الفاتورة عبر واتساب: "+(((c=(s=o.response)==null?void 0:s.data)==null?void 0:c.message)||o.message))}},A=async()=>{try{const a=await y.getProducts();k.value=a.data.data||a.data||[]}catch(a){console.error("Failed to load products:",a),k.value=[]}},ie=async()=>{try{const a=await y.getCustomers();z.value=a.data.data||a.data||[]}catch(a){console.error("Failed to load customers:",a),z.value=[]}};return pe(()=>{A(),ie()}),(a,t)=>(p(),d("div",we,[e("div",Ce,[e("div",qe,[e("div",Me,[e("div",Pe,[v(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>f.value=s),onInput:te,type:"text",placeholder:"ابحث بالاسم أو الباركود...",class:"input pl-10"},null,544),[[b,f.value]]),m(l(_e),{class:"absolute left-3 top-3 text-gray-400",size:20})]),e("button",{onClick:se,class:"btn btn-primary flex items-center gap-2"},[m(l(he),{size:20}),t[12]||(t[12]=J(" مسح الباركود ",-1))])])]),e("div",ze,[(p(!0),d($,null,I(ee.value,s=>{var c;return p(),d("div",{key:s.id,onClick:o=>Q(s),class:"card hover:shadow-lg cursor-pointer transition-all hover:scale-105"},[e("div",Se,[m(l(ye),{size:48,class:"text-gray-400"})]),e("h4",je,i(s.name_ar),1),e("p",Ue,i((c=s.brand)==null?void 0:c.name_ar),1),e("div",$e,[e("span",Ie,i(l(P)(s.selling_price)),1),e("span",{class:X(["text-xs badge",s.stock_quantity>0?"badge-success":"badge-danger"])},i(l(B)(s.stock_quantity))+" قطعة ",3)])],8,Ve)}),128))])]),e("div",Be,[e("div",Fe,[e("h3",Te,[m(l(ke),{size:24}),t[13]||(t[13]=J(" سلة المشتريات ",-1))]),e("div",Ae,[u.value.length===0?(p(),d("div",De," السلة فارغة ")):U("",!0),(p(!0),d($,null,I(u.value,s=>(p(),d("div",{key:s.product.id,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg"},[e("div",Le,[e("p",Ne,i(s.product.name_ar),1),e("p",We,i(l(P)(s.product.selling_price)),1)]),e("div",Ee,[e("button",{onClick:c=>oe(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[m(l(xe),{size:16,class:"mx-auto"})],8,Qe),e("span",He,i(l(B)(s.quantity)),1),e("button",{onClick:c=>ae(s),class:"w-7 h-7 rounded bg-gray-200 hover:bg-gray-300"},[m(l(fe),{size:16,class:"mx-auto"})],8,Ke)]),e("button",{onClick:c=>H(s),class:"text-red-600 hover:text-red-800"},[m(l(be),{size:18})],8,Re)]))),128))]),e("div",Oe,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium mb-2"},"العميل (اختياري)",-1)),e("div",Ge,[v(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>w.value=s),class:"input flex-1"},[t[14]||(t[14]=e("option",{value:""},"عميل عادي",-1)),(p(!0),d($,null,I(z.value,s=>(p(),d("option",{key:s.id,value:s.id},i(s.name)+" - "+i(l(B)(s.phone)),9,Je))),128))],512),[[ve,w.value]]),e("button",{onClick:t[2]||(t[2]=s=>q.value=!0),class:"btn btn-secondary"},[m(l(ge),{size:18})])])]),e("div",Xe,[e("div",Ye,[t[16]||(t[16]=e("span",null,"المجموع الفرعي:",-1)),e("span",Ze,i(l(P)(N.value)),1)]),e("div",et,[t[17]||(t[17]=e("span",null,"الخصم:",-1)),v(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>g.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,g.value,void 0,{number:!0}]])]),e("div",tt,[t[18]||(t[18]=e("span",null,"الضريبة:",-1)),v(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>x.value=s),type:"number",step:"0.01",class:"input w-32 text-left py-1"},null,512),[[b,x.value,void 0,{number:!0}]])]),e("div",st,[t[19]||(t[19]=e("span",null,"الإجمالي:",-1)),e("span",at,i(l(P)(M.value)),1)]),e("div",ot,[t[20]||(t[20]=e("span",null,"المبلغ المدفوع:",-1)),v(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>C.value=s),type:"number",step:"0.01",placeholder:M.value.toString(),class:"input w-32 text-left py-1"},null,8,lt),[[b,C.value,void 0,{number:!0}]])]),W.value>0?(p(),d("div",nt,[t[21]||(t[21]=e("span",null,"المتبقي:",-1)),e("span",null,i(l(P)(W.value)),1)])):U("",!0)]),e("div",rt,[t[22]||(t[22]=e("label",{class:"block text-sm font-medium mb-2"},"طريقة الدفع",-1)),e("div",ut,[(p(),d($,null,I(Z,s=>e("button",{key:s.value,onClick:c=>T.value=s.value,class:X([T.value===s.value?"bg-primary-600 text-white":"bg-gray-100","py-2 rounded-lg font-medium transition-all"])},i(s.label),11,it)),64))])]),e("div",ct,[e("button",{onClick:re,disabled:u.value.length===0,class:"btn btn-success w-full py-3 text-lg"}," إتمام البيع ",8,dt),e("button",{onClick:le,class:"btn btn-secondary w-full"}," مسح السلة ")])])]),V.value?(p(),d("div",pt,[e("div",vt,[t[23]||(t[23]=e("h3",{class:"text-2xl font-bold mb-4"},"مسح الباركود",-1)),v(e("input",{ref_key:"barcodeInput",ref:L,"onUpdate:modelValue":t[6]||(t[6]=s=>h.value=s),onKeyup:me(E,["enter"]),type:"text",placeholder:"امسح أو اكتب الباركود...",class:"input mb-4",autofocus:""},null,544),[[b,h.value]]),e("div",mt,[e("button",{onClick:t[7]||(t[7]=s=>V.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),e("button",{onClick:E,class:"btn btn-primary flex-1"},"بحث")])])])):U("",!0),q.value?(p(),d("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:t[11]||(t[11]=Y(s=>q.value=!1,["self"]))},[e("div",yt,[t[27]||(t[27]=e("h3",{class:"text-2xl font-bold mb-4"},"إضافة عميل",-1)),e("form",{onSubmit:Y(ne,["prevent"]),class:"space-y-4"},[e("div",null,[t[24]||(t[24]=e("label",{class:"block text-sm font-medium mb-2"},"الاسم *",-1)),v(e("input",{"onUpdate:modelValue":t[8]||(t[8]=s=>_.value.name=s),type:"text",required:"",class:"input"},null,512),[[b,_.value.name]])]),e("div",null,[t[25]||(t[25]=e("label",{class:"block text-sm font-medium mb-2"},"رقم الهاتف *",-1)),v(e("input",{"onUpdate:modelValue":t[9]||(t[9]=s=>_.value.phone=s),type:"tel",required:"",class:"input"},null,512),[[b,_.value.phone]])]),e("div",ft,[e("button",{type:"button",onClick:t[10]||(t[10]=s=>q.value=!1),class:"btn btn-secondary flex-1"},"إلغاء"),t[26]||(t[26]=e("button",{type:"submit",class:"btn btn-primary flex-1"},"حفظ",-1))])],32)])])):U("",!0)]))}};export{Mt as default};
